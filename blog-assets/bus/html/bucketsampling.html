<!DOCTYPE html> 
<html lang='en-US' xml:lang='en-US'> 
<head><title>Weighted sampling library</title> 
<meta charset='utf-8' /> 
<meta content='TeX4ht (https://tug.org/tex4ht/)' name='generator' /> 
<meta content='width=device-width,initial-scale=1' name='viewport' /> 
<link href='bucketsampling.css' rel='stylesheet' type='text/css' /> 
<meta content='bucketsampling.tex' name='src' /> 
</head><body>
   <div class='maketitle'>
                                                                                         
                                                                                         
                                                                                         
                                                                                         

<h2 class='titleHead'>Weighted sampling library</h2>
 <div class='author'><span class='ecrm-1200'>Ziwen Wang</span></div><br />
<div class='date'><span class='ecrm-1200'>February 23, 2026</span></div>
   </div>
<!-- l. 58 --><p class='indent'>   In this writing we will study practically efficient method for weighted sampling.
</p>
   <h3 class='sectionHead' id='theoretical-discussion'><span class='titlemark'>1   </span> <a id='x1-10001'></a>Theoretical discussion</h3>
   <div class='newtheorem'>
<!-- l. 62 --><p class='noindent'><span class='head'>
<a id='x1-1001r1'></a>
<span class='ecbx-1095'>Definition 1 </span>(WSS)<span class='ecbx-1095'>.</span>  </span>Let <!-- l. 63 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>S</mi></math>
be an input set of <!-- l. 63 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>n</mi></math>
element. For each <!-- l. 63 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub> <mo class='MathClass-rel' stretchy='false'>∈</mo> <mi>S</mi></mrow></math>
we define <!-- l. 64 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-rel' stretchy='false'>∈</mo> <msub><mrow><mi>ℝ</mi></mrow><mrow><mo class='MathClass-bin' stretchy='false'>+</mo></mrow></msub></mrow></math>
to be the weight of element <!-- l. 64 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub></math>.
Given an input <!-- l. 65 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>t</mi> <mo class='MathClass-rel' stretchy='false'>∈</mo> <msub><mrow><mi>ℤ</mi></mrow><mrow><mo class='MathClass-bin' stretchy='false'>+</mo></mrow></msub></mrow></math>
the WSS returns <!-- l. 65 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>-independent
samples from <!-- l. 65 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>S</mi></math>,
each element <!-- l. 66 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
is sampled with respect to <!-- l. 66 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
<mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></mfrac> </mrow></math>,
where <!-- l. 67 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-punc' stretchy='false'>:</mo><mo class='MathClass-rel' stretchy='false'>=</mo><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-rel' stretchy='false'>∈</mo><mi>S</mi></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>a</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>.
</p>
   </div>
<!-- l. 68 --><p class='indent'>
</p><!-- l. 70 --><p class='noindent'>It is not hard to see by using a standard balanced binary search tree method one can solve such a problem in
<!-- l. 70 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>tlog</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time, with
preprocess time <!-- l. 71 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>nlog</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> and
space compelxity <!-- l. 71 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>.
The advantage of using a tree is that updating the weight becomes trivial in
<!-- l. 72 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time. On the other
hand one can use <!-- l. 73 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>n</mi></math>
bucket’s to achieve <!-- l. 73 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>t</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
time for sampling <!-- l. 73 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>t</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
                                                                                         
                                                                                         
items, but this method does not support weight update, if a weight of an element changed then the whole data structure
have to be built in <!-- l. 75 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
time.
</p><!-- l. 77 --><p class='indent'>   The question is then can we combine the advantages together? i.e. Does there exists an data structure that solves the
above problem in <!-- l. 78 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>t</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
time with <!-- l. 79 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
update, <!-- l. 79 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> space
complexity and, <!-- l. 79 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
preprocessing time? The answer is yes, theoretically.
</p>
   <div class='newtheorem'>
<!-- l. 81 --><p class='noindent'><span class='head'>
<a id='x1-1002r2'></a>
<span class='ecbx-1095'>Theorem 2.</span>  </span><span class='ecti-1095'>There exists a data structures that solves the WSS problem in </span><!-- l. 82 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>t</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>time for </span><!-- l. 83 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>
<span class='ecti-1095'>samples. The required preprocessing time for </span><!-- l. 83 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>n</mi></math>
<span class='ecti-1095'>element is </span><!-- l. 83 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>with space complexity </span><!-- l. 84 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math><span class='ecti-1095'>.
The update requires </span><!-- l. 84 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>time.</span>
</p>
   </div>
<!-- l. 85 --><p class='indent'>
</p><!-- l. 87 --><p class='indent'>   The above method is not good in practice, the reaons is because they have designed nested levels of
bucketing and as a result it has a large hidden constant factor makeing it impractical.
</p><!-- l. 91 --><p class='noindent'>
</p>
   <h4 class='subsectionHead' id='bucket-sampling'><span class='titlemark'>1.1   </span> <a id='x1-20001.1'></a>Bucket sampling</h4>
<!-- l. 92 --><p class='noindent'>Suppose  we  have  a  set  of  buckets,  each  bucket
<!-- l. 92 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math> contains element with weight
ranging in <!-- l. 93 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mo class='MathClass-open' stretchy='false'>[</mo><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi></mrow></msup><mo class='MathClass-punc' stretchy='false'>,</mo><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math>. One subproblem we
want to solve is given a bucket <!-- l. 94 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
how would we sample an element <!-- l. 94 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>a</mi> <mo class='MathClass-rel' stretchy='false'>∈</mo> <msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></math>
with probability <!-- l. 95 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow>    <mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
<mrow><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>b</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></mfrac></mrow></math>
in constant time? The idea is the following procedure,
</p><!-- l. 98 --><p class='indent'>
     </p><dl class='enumerate-enumitem'><dt class='enumerate-enumitem'>
   1. </dt><dd class='enumerate-enumitem'><!-- l. 98 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>rand</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>,
     sample a point from <!-- l. 98 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
     uniformly.
     </dd><dt class='enumerate-enumitem'>
   2. </dt><dd class='enumerate-enumitem'>if <!-- l. 99 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>≤</mo> <mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
                                                                                         
                                                                                         
     then return <!-- l. 99 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
     else repeat.</dd></dl>
   <div class='newtheorem'>
<!-- l. 102 --><p class='noindent'><span class='head'>
<a id='x1-2003r3'></a>
<span class='ecbx-1095'>Lemma 3.</span>  </span><span class='ecti-1095'>The above procedure ends in </span><!-- l. 103 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>expected time and samples </span><!-- l. 103 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
<span class='ecti-1095'>with probability </span><!-- l. 104 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow>    <mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
<mrow><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>b</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></mfrac></mrow></math><span class='ecti-1095'>.</span>
</p>
   </div>
<!-- l. 105 --><p class='indent'>
</p>
   <div class='proof'>
<!-- l. 108 --><p class='indent'>   <span class='head'>
<span class='ecti-1095'>Proof.</span> </span>Since
<!-- l. 108 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-rel' stretchy='false'>≥</mo> <msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi></mrow></msup></mrow></math>
and
<!-- l. 108 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>ran</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
then       by       expectation       we       know       that       we       should       end       within
<!-- l. 109 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mn>2</mn></math>
iterations in expectation.
</p><!-- l. 111 --><p class='indent'>   Suppose we are at iteration <!-- l. 111 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>,
then the probability that we accept <!-- l. 111 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
is the product of the probability that <!-- l. 112 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>≤</mo> <mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
and we sampled <!-- l. 112 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
uniformly from <!-- l. 113 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
which is exactly <!-- l. 113 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow>  <mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
<mrow><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-rel' stretchy='false'>|</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-rel' stretchy='false'>|</mo></mrow></mfrac></mrow></math>.
The probabilty that we return in iteration <!-- l. 114 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>
is <!-- l. 114 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></msub><mi mathvariant='italic'>Pr</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>b</mi><mstyle class='text'><mtext> is returned</mtext></mstyle><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-rel' stretchy='false'>=</mo> <mfrac><mrow><msub><mrow><mo>∑</mo>
  <!-- nolimits --></mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></msub></mrow> 
<mrow><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-rel' stretchy='false'>|</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-rel' stretchy='false'>|</mo></mrow></mfrac></mrow></math>.
Then letting <!-- l. 116 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>p</mi> <mo class='MathClass-rel' stretchy='false'>=</mo> <mfrac><mrow><msub><mrow><mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></msub></mrow> 
<mrow><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-rel' stretchy='false'>|</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-rel' stretchy='false'>|</mo></mrow></mfrac></mrow></math>
and <!-- l. 117 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>q</mi> <mo class='MathClass-rel' stretchy='false'>=</mo>   <mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow> 
<mrow><msup><mrow><mn>2</mn></mrow><mrow><mi>i</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></msup><mo class='MathClass-rel' stretchy='false'>|</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-rel' stretchy='false'>|</mo></mrow></mfrac></mrow></math>
we see that the probability we sampled <!-- l. 117 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
is:
                                                                                         
                                                                                         
<!-- tex4ht:inline --></p><!-- l. 118 --><math display='block' xmlns='http://www.w3.org/1998/Math/MathML'><mrow>
                    <munderover accent='false' accentunder='false'><mrow><mo>∑</mo>
  </mrow><mrow><mi>t</mi><mo class='MathClass-rel' stretchy='false'>=</mo><mn>1</mn></mrow><mrow><mi>∞</mi></mrow></munderover><msup><mrow><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn> <mo class='MathClass-bin' stretchy='false'>−</mo> <mi>p</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow><mrow><mi>t</mi><mo class='MathClass-bin' stretchy='false'>−</mo><mn>1</mn></mrow></msup><mi>q</mi> <mo class='MathClass-rel' stretchy='false'>=</mo> <mi>q</mi><munderover accent='false' accentunder='false'><mrow><mo>∑</mo>
  </mrow><mrow><mi>t</mi><mo class='MathClass-rel' stretchy='false'>=</mo><mn>1</mn></mrow><mrow><mi>∞</mi></mrow></munderover> <mo class='MathClass-rel' stretchy='false'>=</mo> <mi>q</mi><mo class='MathClass-bin' stretchy='false'>∕</mo><mi>p</mi> <mo class='MathClass-rel' stretchy='false'>=</mo>      <mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>a</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow> 
<mrow><munder class='msub'><mrow><mo>∑</mo>
  </mrow><mrow><mi>b</mi><mo class='MathClass-rel' stretchy='false'>∈</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></mrow></munder><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>b</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></mfrac><mo class='MathClass-punc' stretchy='false'>,</mo>
</mrow></math>
<!-- l. 118 --><p class='nopar'> as required.                                                                                                                □
</p>
   </div>
<!-- l. 122 --><p class='indent'>   So now the challenge is actually how do we sampled the buckets i.e. each bucket is sampled with probabilty
<!-- l. 123 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
 <mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></mfrac> </mrow></math>. The idea is to
actually sample <!-- l. 124 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>rand</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
and then examine from the high weight buckets to the lower weight bucket one by one, in the worst case we may
examine <!-- l. 125 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>n</mi></math>
buckets, but this happens rarely as summarized by the following lemma.
</p>
   <div class='newtheorem'>
<!-- l. 128 --><p class='noindent'><span class='head'>
<a id='x1-2004r4'></a>
<span class='ecbx-1095'>Lemma 4.</span>  </span><span class='ecti-1095'>Let </span><!-- l. 129 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>r</mi></math>
<span class='ecti-1095'>be the largest weight non-empty bucket </span><!-- l. 129 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi></mrow></msub></math><span class='ecti-1095'>,
then the sum of weights falling into buckets smaller than </span><!-- l. 130 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>r</mi> <mo class='MathClass-bin' stretchy='false'>−</mo> <mn>2</mn><mo class='MathClass-open' stretchy='false'>⌈</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌉</mo></mrow></math>
<span class='ecti-1095'>is at most </span><!-- l. 130 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mfrac><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow>
<mrow><mi>n</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></mfrac> </mrow></math><span class='ecti-1095'>.</span>
</p>
   </div>
<!-- l. 131 --><p class='indent'>    By the above lemma we know with probability
<!-- l. 132 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mfrac><mrow><mi>n</mi><mo class='MathClass-bin' stretchy='false'>−</mo><mn>1</mn></mrow>
<mrow><mi>n</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></mfrac></math> we are going to incur a
cost of <!-- l. 133 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> by examining
buckets in <!-- l. 133 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mo class='MathClass-open' stretchy='false'>[</mo><mi>r</mi> <mo class='MathClass-bin' stretchy='false'>−</mo> <mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo><mo class='MathClass-punc' stretchy='false'>,</mo><mi>r</mi><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math> and with
probability <!-- l. 133 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow>  <mfrac><mrow><mn>1</mn></mrow>
<mrow><mi>n</mi><mo class='MathClass-bin' stretchy='false'>+</mo><mn>1</mn></mrow></mfrac></mrow></math> we are
going to incur a cost of <!-- l. 134 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
to examine buckets <!-- l. 134 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow> <mo class='MathClass-rel' stretchy='false'>&lt;</mo> <mi>r</mi> <mo class='MathClass-bin' stretchy='false'>−</mo> <mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo></mrow></math>, so
the amortized time is <!-- l. 135 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>.
A naive algorithm would be,
     </p><dl class='enumerate-enumitem'><dt class='enumerate-enumitem'>
   1. </dt><dd class='enumerate-enumitem'><!-- l. 137 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>rand</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
     do a linear scan to find a bucket <!-- l. 137 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
     such that <!-- l. 138 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>j</mi><mo class='MathClass-rel' stretchy='false'>&lt;</mo><mi>i</mi></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>j</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-rel' stretchy='false'>&lt;</mo> <mi>x</mi> <mo class='MathClass-rel' stretchy='false'>≤</mo><msub><mrow><mo>∑</mo>
  <!-- nolimits --></mrow><mrow><mi>j</mi><mo class='MathClass-rel' stretchy='false'>≤</mo><mi>i</mi></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>j</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>.
     </dd><dt class='enumerate-enumitem'>
   2. </dt><dd class='enumerate-enumitem'>Use previously mentioned procedure to sample an element <!-- l. 139 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
     from <!-- l. 139 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
     in constant time.</dd></dl>
                                                                                         
                                                                                         
<!-- l. 143 --><p class='indent'>   It is not hard to see that the above procedure samples
<!-- l. 143 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math> element
in <!-- l. 144 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>tlog</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
amortized time and the reason for this is because we need to incur
<!-- l. 145 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
cost to first find the desired bucket, can we lower this down to
<!-- l. 146 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
amortized time? The answer is yes, first let the cut off point be
<!-- l. 147 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>C</mi> <mo class='MathClass-punc' stretchy='false'>:</mo><mo class='MathClass-rel' stretchy='false'>=</mo><msub><mrow> <mi class='MathClass-op'>∑</mi><mo> ⁡<!-- FUNCTION APPLICATION --></mo>
  <!-- nolimits --></mrow><mrow><mi>i</mi><mo class='MathClass-rel' stretchy='false'>&lt;</mo><mi>r</mi><mo class='MathClass-bin' stretchy='false'>−</mo><mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo></mrow></msub><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> then if
we sampled <!-- l. 148 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>rand</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
such that <!-- l. 148 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>≥</mo> <mi>C</mi></mrow></math>
we are in the good case and otherwise we are in the bad case. For the bad case this only happens
<!-- l. 150 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow> <mo class='MathClass-rel' stretchy='false'>≤</mo> <mfrac><mrow><mn>1</mn></mrow> 
<mrow><mi>n</mi></mrow></mfrac></mrow></math> time and incurs
a cost of <!-- l. 150 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
and for the good case we can build an Alias data structure on non-empty buckets from
<!-- l. 152 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mo class='MathClass-open' stretchy='false'>[</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi><mo class='MathClass-bin' stretchy='false'>−</mo><mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo></mrow></msub><mo class='MathClass-punc' stretchy='false'>,</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>,</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math> with
weight <!-- l. 153 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mo class='MathClass-open' stretchy='false'>[</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi><mo class='MathClass-bin' stretchy='false'>−</mo><mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-punc' stretchy='false'>,</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>.</mo><mo class='MathClass-punc' stretchy='false'>,</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi></mrow></msub><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math>
which costs <!-- l. 153 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
space and time to preprocess, and once it is preprocessed it only requires
<!-- l. 154 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time to
sample an bucket. Thus we have the following procedure,
</p><!-- l. 158 --><p class='indent'>
     </p><dl class='enumerate-enumitem'><dt class='enumerate-enumitem'>
   1. </dt><dd class='enumerate-enumitem'>Build an Alias data structure on nonempty buckets ranging from <!-- l. 159 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mo class='MathClass-open' stretchy='false'>[</mo><mi>r</mi> <mo class='MathClass-bin' stretchy='false'>−</mo> <mn>2</mn><mo class='MathClass-open' stretchy='false'>⌊</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌋</mo><mo class='MathClass-punc' stretchy='false'>,</mo><mi>r</mi><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math>,
     and let <!-- l. 159 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>C</mi></math>
     be the cutoff point as defined above.
     </dd><dt class='enumerate-enumitem'>
   2. </dt><dd class='enumerate-enumitem'><!-- l. 160 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>←</mo> <mi mathvariant='italic'>rand</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>0</mn><mo class='MathClass-punc' stretchy='false'>,</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>.
     If <!-- l. 160 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>x</mi> <mo class='MathClass-rel' stretchy='false'>&lt;</mo> <mi>C</mi></mrow></math>
     then we are in the bad case do a linear scan to find the bucket else sample a bucket from the
     Alias data strcture. Call this bucket <!-- l. 162 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>.
     </dd><dt class='enumerate-enumitem'>
   3. </dt><dd class='enumerate-enumitem'>Use previously mentioned procedure to sample an element <!-- l. 163 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
     from <!-- l. 163 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>i</mi></mrow></msub></math>
     in constant time.
     </dd><dt class='enumerate-enumitem'>
   4. </dt><dd class='enumerate-enumitem'>Repeat until we have <!-- l. 165 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>
     samples.</dd></dl>
<!-- l. 168 --><p class='indent'>   The above procedure samples <!-- l. 168 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>
elements in <!-- l. 168 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo> <mo class='MathClass-bin' stretchy='false'>+</mo> <mi>t</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time. For updating
the weight of an element <!-- l. 169 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>a</mi> <mo class='MathClass-rel' stretchy='false'>∈</mo> <mi>S</mi></mrow></math>
we first need remove <!-- l. 169 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math> and
insert <!-- l. 169 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math> into the appropiate
bucket which can be done in <!-- l. 170 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
time by book keeping where <!-- l. 170 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>a</mi></math>
                                                                                         
                                                                                         
is stored at. The value <!-- l. 171 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>r</mi></math>,
largest non-empty bucket <!-- l. 171 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi></mrow></msub></math>,
can also be book keeped easily if we only allow updates i.e. no insert or
delete. Once we allow insert or delete it is not so clear how we can book keep
<!-- l. 173 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>r</mi></math> in
<!-- l. 173 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time but we can
indeed book keep in <!-- l. 174 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
time by balanced binary search tree, another approach is to recalculate
<!-- l. 175 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>r</mi></math> in
<!-- l. 175 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>N</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
during the sampling procedure so update (including insert and delete) stays in
<!-- l. 176 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math> time
which is summarized by the following lemma.
</p>
   <div class='newtheorem'>
<!-- l. 178 --><p class='noindent'><span class='head'>
<a id='x1-2011r5'></a>
<span class='ecbx-1095'>Lemma 5.</span>  </span><span class='ecti-1095'>Let </span><!-- l. 179 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>be the sum of all weights in </span><!-- l. 179 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>S</mi></math><span class='ecti-1095'>,
let </span><!-- l. 179 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><msup><mrow><mi>r</mi></mrow><mrow><mi>′</mi></mrow></msup> <mo class='MathClass-rel' stretchy='false'>=</mo> <mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>w</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>S</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>then the largest non-empty bucket </span><!-- l. 180 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><msub><mrow><mi>B</mi></mrow><mrow><mi>r</mi></mrow></msub></math>
<span class='ecti-1095'>has </span><!-- l. 180 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>r</mi> <mo class='MathClass-rel' stretchy='false'>∈</mo> <mo class='MathClass-open' stretchy='false'>[</mo><msup><mrow><mi>r</mi></mrow><mrow><mi>′</mi></mrow></msup><mo class='MathClass-bin' stretchy='false'>−</mo><mo class='MathClass-open' stretchy='false'>⌈</mo><mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>⌉</mo><mo class='MathClass-punc' stretchy='false'>,</mo><msup><mrow><mi>r</mi></mrow><mrow><mi>′</mi></mrow></msup><mo class='MathClass-close' stretchy='false'>]</mo></mrow></math><span class='ecti-1095'>.</span>
</p>
   </div>
<!-- l. 181 --><p class='indent'>
</p>
   <div class='newtheorem'>
<!-- l. 183 --><p class='noindent'><span class='head'>
<a id='x1-2012r6'></a>
<span class='ecbx-1095'>Theorem 6.</span>  </span><span class='cite'><span class='ecti-1095'>[</span><a href='#XWSS'><span class='ecti-1095'>ZJW23</span></a><span class='ecti-1095'>]</span></span> <span class='ecti-1095'>There exists a data structures that solves the WSS problem in </span><!-- l. 184 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>t</mi> <mo class='MathClass-bin' stretchy='false'>+</mo> <mi mathvariant='italic'>log</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>amortized time for </span><!-- l. 185 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>t</mi></math>
<span class='ecti-1095'>samples. The required preprocessing time for </span><!-- l. 185 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mi>n</mi></math>
<span class='ecti-1095'>element is </span><!-- l. 185 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>with space complexity </span><!-- l. 186 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mi>n</mi><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math><span class='ecti-1095'>.
The update requires </span><!-- l. 186 --><math display='inline' xmlns='http://www.w3.org/1998/Math/MathML'><mrow><mi>O</mi><mo class='MathClass-open' stretchy='false'>(</mo><mn>1</mn><mo class='MathClass-close' stretchy='false'>)</mo></mrow></math>
<span class='ecti-1095'>time. NOTE: The hidden constants are small which makes this data structure practical.</span>
</p>
   </div>
<!-- l. 188 --><p class='indent'>
                                                                                         
                                                                                         
</p><!-- l. 190 --><p class='noindent'>
</p>
   <h3 class='sectionHead' id='implementation'><span class='titlemark'>2   </span> <a id='x1-30002'></a>Implementation</h3>
<!-- l. 191 --><p class='noindent'>Note that the author of the paper has its own implementation but there are several cavaets, the first one
being we aim for a much simpler and clean implementation for maintiability and usability, for detail please
see WSS class below.
</p>
   <!-- l. 195 -->
<figcaption class='caption'><span class='id'>0cAp0x1-30002:
    </span><span class='content'>wss.h</span></figcaption><!-- tex4ht:label?: x1-30002  --><pre class='lstlisting' id='listing-1'><span class='label'><a id='x1-3001r1'></a><span class='ecrm-0600'>1</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>ifndef</span></span><span style='color:#000000'> <span class='ectt-1000'>WSS_H</span> 
</span><span class='label'><a id='x1-3002r2'></a><span class='ecrm-0600'>2</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>define</span></span><span style='color:#000000'> <span class='ectt-1000'>WSS_H</span> 
</span><span class='label'><a id='x1-3003r3'></a><span class='ecrm-0600'>3</span></span> 
<span class='label'><a id='x1-3004r4'></a><span class='ecrm-0600'>4</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;concepts&gt;</span> 
</span><span class='label'><a id='x1-3005r5'></a><span class='ecrm-0600'>5</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;vector&gt;</span> 
</span><span class='label'><a id='x1-3006r6'></a><span class='ecrm-0600'>6</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;random&gt;</span> 
</span><span class='label'><a id='x1-3007r7'></a><span class='ecrm-0600'>7</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;assert.h&gt;</span> 
</span><span class='label'><a id='x1-3008r8'></a><span class='ecrm-0600'>8</span></span> 
<span class='label'><a id='x1-3009r9'></a><span class='ecrm-0600'>9</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>define</span></span><span style='color:#000000'> <span class='ectt-1000'>EPS 1e-6</span> 
</span><span class='label'><a id='x1-3010r10'></a><span class='ecrm-0600'>10</span></span> 
<span class='label'><a id='x1-3011r11'></a><span class='ecrm-0600'>11</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>typename</span></span><span style='color:#000000'> <span class='ectt-1000'>U&gt;</span> 
</span><span class='label'><a id='x1-3012r12'></a><span class='ecrm-0600'>12</span></span><span style='color:#000000'><span class='ectt-1000'>concept</span></span><span style='color:#000000'> <span class='ectt-1000'>Numeric = std::integral&lt;U&gt; || std::floating_point&lt;U&gt;;</span> 
</span><span class='label'><a id='x1-3013r13'></a><span class='ecrm-0600'>13</span></span> 
<span class='label'><a id='x1-3014r14'></a><span class='ecrm-0600'>14</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>typename</span></span><span style='color:#000000'> <span class='ectt-1000'>C,</span> </span><span style='color:#0000FF'><span class='ectt-1000'>typename</span></span><span style='color:#000000'> <span class='ectt-1000'>U&gt;</span> 
</span><span class='label'><a id='x1-3015r15'></a><span class='ecrm-0600'>15</span></span><span style='color:#000000'><span class='ectt-1000'>concept</span></span><span style='color:#000000'> <span class='ectt-1000'>ContainerOf = requires(C c, std::size_t i) {</span> 
</span><span class='label'><a id='x1-3016r16'></a><span class='ecrm-0600'>16</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>{</span></span><span style='color:#000000'> <span class='ectt-1000'>c.begin() };</span> 
</span><span class='label'><a id='x1-3017r17'></a><span class='ecrm-0600'>17</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>{</span></span><span style='color:#000000'> <span class='ectt-1000'>c.end() };</span> 
</span><span class='label'><a id='x1-3018r18'></a><span class='ecrm-0600'>18</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>{</span></span><span style='color:#000000'> <span class='ectt-1000'>c.size() } -&gt; std::convertible_to&lt;std::size_t&gt;;</span> 
</span><span class='label'><a id='x1-3019r19'></a><span class='ecrm-0600'>19</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>{</span></span><span style='color:#000000'> <span class='ectt-1000'>c[i] } -&gt; std::convertible_to&lt;U&gt;;</span> 
</span><span class='label'><a id='x1-3020r20'></a><span class='ecrm-0600'>20</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>{</span></span><span style='color:#000000'> <span class='ectt-1000'>c.data() } -&gt; std::convertible_to&lt;U*&gt;;</span> 
</span><span class='label'><a id='x1-3021r21'></a><span class='ecrm-0600'>21</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3022r22'></a><span class='ecrm-0600'>22</span></span> 
<span class='label'><a id='x1-3023r23'></a><span class='ecrm-0600'>23</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;Numeric T&gt;</span> 
</span><span class='label'><a id='x1-3024r24'></a><span class='ecrm-0600'>24</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>rand(T l, T r) {</span> 
</span><span class='label'><a id='x1-3025r25'></a><span class='ecrm-0600'>25</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>static</span></span><span style='color:#000000'> <span class='ectt-1000'>thread_local std::mt19937 gen{std::random_device{}()};</span> 
</span><span class='label'><a id='x1-3026r26'></a><span class='ecrm-0600'>26</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>constexpr (std::integral&lt;T&gt;) {</span> 
</span><span class='label'><a id='x1-3027r27'></a><span class='ecrm-0600'>27</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>uniform_int_distribution</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>dist(l, r);</span> 
</span><span class='label'><a id='x1-3028r28'></a><span class='ecrm-0600'>28</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>dist(gen);</span> 
</span><span class='label'><a id='x1-3029r29'></a><span class='ecrm-0600'>29</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3030r30'></a><span class='ecrm-0600'>30</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>uniform_real_distribution</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>dist(l, r);</span> 
</span><span class='label'><a id='x1-3031r31'></a><span class='ecrm-0600'>31</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>dist(gen);</span> 
</span><span class='label'><a id='x1-3032r32'></a><span class='ecrm-0600'>32</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3033r33'></a><span class='ecrm-0600'>33</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3034r34'></a><span class='ecrm-0600'>34</span></span> 
<span class='label'><a id='x1-3035r35'></a><span class='ecrm-0600'>35</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> <span class='ectt-1000'>std::size_t rand&lt;std::size_t&gt;(std::size_t, std::size_t);</span> 
</span><span class='label'><a id='x1-3036r36'></a><span class='ecrm-0600'>36</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>rand&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3037r37'></a><span class='ecrm-0600'>37</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>double</span></span><span style='color:#000000'> <span class='ectt-1000'>rand&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>double</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(</span></span><span style='color:#0000FF'><span class='ectt-1000'>double</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>double</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3038r38'></a><span class='ecrm-0600'>38</span></span> 
<span class='label'><a id='x1-3039r39'></a><span class='ecrm-0600'>39</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;Numeric T, ContainerOf&lt;T&gt; C =</span> </span><span class='ectt-1000'> </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;&gt;</span></span> 
<span class='label'><a id='x1-3040r40'></a><span class='ecrm-0600'>40</span></span><span style='color:#0000FF'><span class='ectt-1000'>class</span></span><span style='color:#000000'> <span class='ectt-1000'>WSS {</span> 
</span><span class='label'><a id='x1-3041r41'></a><span class='ecrm-0600'>41</span></span><span style='color:#0000FF'><span class='ectt-1000'>public</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3042r42'></a><span class='ecrm-0600'>42</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>WSS</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>C &amp;weight) : weight_(weight), n_(weight.size()) {</span> 
</span><span class='label'><a id='x1-3043r43'></a><span class='ecrm-0600'>43</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>assert</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>weight</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>cannot</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>have</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>size</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>0</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#000000'> <span class='ectt-1000'>&amp;&amp; n_);</span> 
</span><span class='label'><a id='x1-3044r44'></a><span class='ecrm-0600'>44</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3045r45'></a><span class='ecrm-0600'>45</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>virtual</span></span><span style='color:#000000'> <span class='ectt-1000'>~WSS() =</span> </span><span style='color:#0000FF'><span class='ectt-1000'>default</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3046r46'></a><span class='ecrm-0600'>46</span></span> 
<span class='label'><a id='x1-3047r47'></a><span class='ecrm-0600'>47</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>virtual</span></span><span style='color:#000000'> <span class='ectt-1000'>std::vector&lt;std::size_t&gt; sample(std::size_t m) = 0;</span> 
</span><span class='label'><a id='x1-3048r48'></a><span class='ecrm-0600'>48</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>virtual</span></span><span style='color:#000000'> <span class='ectt-1000'>std::size_t sample() = 0;</span> 
</span><span class='label'><a id='x1-3049r49'></a><span class='ecrm-0600'>49</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>virtual</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>bool</span></span><span style='color:#000000'> <span class='ectt-1000'>update(std::size_t idx, T weight) = 0;</span> 
</span><span class='label'><a id='x1-3050r50'></a><span class='ecrm-0600'>50</span></span><span style='color:#0000FF'><span class='ectt-1000'>protected</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3051r51'></a><span class='ecrm-0600'>51</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>C</span></span><span style='color:#000000'> <span class='ectt-1000'>weight_;</span> 
</span><span class='label'><a id='x1-3052r52'></a><span class='ecrm-0600'>52</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>n_;</span> 
</span><span class='label'><a id='x1-3053r53'></a><span class='ecrm-0600'>53</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3054r54'></a><span class='ecrm-0600'>54</span></span> 
<span class='label'><a id='x1-3055r55'></a><span class='ecrm-0600'>55</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>endif</span></span><span style='color:#000000'> </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'><span class='ectt-1000'>WSS_H</span></span></pre>
   <!-- l. 254 -->
<figcaption class='caption'><span class='id'>0cAp1x1-3057r2:
    </span><span class='content'>alias.h</span></figcaption><!-- tex4ht:label?: x1-3057r2  --><pre class='lstlisting' id='listing-2'><span class='label'><a id='x1-3058r1'></a><span class='ecrm-0600'>1</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>ifndef</span></span><span style='color:#000000'> <span class='ectt-1000'>ALIAS</span> 
</span><span class='label'><a id='x1-3059r2'></a><span class='ecrm-0600'>2</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>define</span></span><span style='color:#000000'> <span class='ectt-1000'>ALIAS</span> 
</span><span class='label'><a id='x1-3060r3'></a><span class='ecrm-0600'>3</span></span> 
<span class='label'><a id='x1-3061r4'></a><span class='ecrm-0600'>4</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;assert.h&gt;</span> 
</span><span class='label'><a id='x1-3062r5'></a><span class='ecrm-0600'>5</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;vector&gt;</span> 
</span><span class='label'><a id='x1-3063r6'></a><span class='ecrm-0600'>6</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;optional&gt;</span> 
</span><span class='label'><a id='x1-3064r7'></a><span class='ecrm-0600'>7</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;utility&gt;</span> 
</span><span class='label'><a id='x1-3065r8'></a><span class='ecrm-0600'>8</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;stdexcept&gt;</span> 
</span><span class='label'><a id='x1-3066r9'></a><span class='ecrm-0600'>9</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;random&gt;</span> 
</span><span class='label'><a id='x1-3067r10'></a><span class='ecrm-0600'>10</span></span> 
<span class='label'><a id='x1-3068r11'></a><span class='ecrm-0600'>11</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> </span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>wss</span></span><span style='color:#FF0000'><span class='ectt-1000'>.</span></span><span style='color:#FF0000'><span class='ectt-1000'>h</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span> 
<span class='label'><a id='x1-3069r12'></a><span class='ecrm-0600'>12</span></span> 
<span class='label'><a id='x1-3070r13'></a><span class='ecrm-0600'>13</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>typename</span></span><span style='color:#000000'> <span class='ectt-1000'>T&gt;</span> 
</span><span class='label'><a id='x1-3071r14'></a><span class='ecrm-0600'>14</span></span><span style='color:#0000FF'><span class='ectt-1000'>struct</span></span><span style='color:#000000'> <span class='ectt-1000'>Node {</span> 
</span><span class='label'><a id='x1-3072r15'></a><span class='ecrm-0600'>15</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>val;</span> 
</span><span class='label'><a id='x1-3073r16'></a><span class='ecrm-0600'>16</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>id;</span> 
</span><span class='label'><a id='x1-3074r17'></a><span class='ecrm-0600'>17</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'> <span class='ectt-1000'>*next = nullptr;</span> 
</span><span class='label'><a id='x1-3075r18'></a><span class='ecrm-0600'>18</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'> <span class='ectt-1000'>*prev = nullptr;</span> 
</span><span class='label'><a id='x1-3076r19'></a><span class='ecrm-0600'>19</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3077r20'></a><span class='ecrm-0600'>20</span></span> 
<span class='label'><a id='x1-3078r21'></a><span class='ecrm-0600'>21</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>typename</span></span><span style='color:#000000'> <span class='ectt-1000'>T&gt;</span> 
</span><span class='label'><a id='x1-3079r22'></a><span class='ecrm-0600'>22</span></span><span style='color:#0000FF'><span class='ectt-1000'>struct</span></span><span style='color:#000000'> <span class='ectt-1000'>OptionalPair {</span> 
</span><span class='label'><a id='x1-3080r23'></a><span class='ecrm-0600'>23</span></span><span class='ectt-1000'>    </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> <span class='ectt-1000'>First is idx and second is weight.</span> 
</span><span class='label'><a id='x1-3081r24'></a><span class='ecrm-0600'>24</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>pair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>T&gt; p1;</span> 
</span><span class='label'><a id='x1-3082r25'></a><span class='ecrm-0600'>25</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>optional</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>pair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>T&gt;&gt; p2;</span> 
</span><span class='label'><a id='x1-3083r26'></a><span class='ecrm-0600'>26</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3084r27'></a><span class='ecrm-0600'>27</span></span> 
<span class='label'><a id='x1-3085r28'></a><span class='ecrm-0600'>28</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C = std::vector&lt;T&gt;&gt;</span> 
</span><span class='label'><a id='x1-3086r29'></a><span class='ecrm-0600'>29</span></span><span style='color:#0000FF'><span class='ectt-1000'>class</span></span><span style='color:#000000'> <span class='ectt-1000'>Alias :</span> </span><span style='color:#0000FF'><span class='ectt-1000'>public</span></span><span style='color:#000000'> <span class='ectt-1000'>WSS&lt;T, C&gt; {</span> 
</span><span class='label'><a id='x1-3087r30'></a><span class='ecrm-0600'>30</span></span><span style='color:#0000FF'><span class='ectt-1000'>public</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3088r31'></a><span class='ecrm-0600'>31</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Alias</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>C &amp;weight);</span> 
</span><span class='label'><a id='x1-3089r32'></a><span class='ecrm-0600'>32</span></span> 
<span class='label'><a id='x1-3090r33'></a><span class='ecrm-0600'>33</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>sample(std::size_t m) override;</span> 
</span><span class='label'><a id='x1-3091r34'></a><span class='ecrm-0600'>34</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>sample() override;</span> 
</span><span class='label'><a id='x1-3092r35'></a><span class='ecrm-0600'>35</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>bool</span></span><span style='color:#000000'> <span class='ectt-1000'>update(std::size_t idx, T weight) override {</span> 
</span><span class='label'><a id='x1-3093r36'></a><span class='ecrm-0600'>36</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>throw</span></span><span style='color:#000000'> <span class='ectt-1000'>std::logic_error(</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>update</span></span><span style='color:#FF0000'><span class='ectt-1000'>()</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>not</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>supported</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>for</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>Alias</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3094r37'></a><span class='ecrm-0600'>37</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3095r38'></a><span class='ecrm-0600'>38</span></span><span style='color:#0000FF'><span class='ectt-1000'>private</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3096r39'></a><span class='ecrm-0600'>39</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>double</span></span><span style='color:#000000'> <span class='ectt-1000'>average_;</span> 
</span><span class='label'><a id='x1-3097r40'></a><span class='ecrm-0600'>40</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>OptionalPair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>bins_;</span> 
</span><span class='label'><a id='x1-3098r41'></a><span class='ecrm-0600'>41</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3099r42'></a><span class='ecrm-0600'>42</span></span> 
<span class='label'><a id='x1-3100r43'></a><span class='ecrm-0600'>43</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3101r44'></a><span class='ecrm-0600'>44</span></span><span style='color:#000000'><span class='ectt-1000'>Alias</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>C&gt;::Alias(</span></span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>C &amp;weight) : WSS&lt;T, C&gt;(weight) {</span> 
</span><span class='label'><a id='x1-3102r45'></a><span class='ecrm-0600'>45</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>average_</span></span><span style='color:#000000'> <span class='ectt-1000'>= 0;</span> 
</span><span class='label'><a id='x1-3103r46'></a><span class='ecrm-0600'>46</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>auto</span></span><span style='color:#000000'> <span class='ectt-1000'>w :</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3104r47'></a><span class='ecrm-0600'>47</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>average_</span></span><span style='color:#000000'> <span class='ectt-1000'>+= w;</span> 
</span><span class='label'><a id='x1-3105r48'></a><span class='ecrm-0600'>48</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3106r49'></a><span class='ecrm-0600'>49</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>average_</span></span><span style='color:#000000'> <span class='ectt-1000'>/=</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3107r50'></a><span class='ecrm-0600'>50</span></span> 
<span class='label'><a id='x1-3108r51'></a><span class='ecrm-0600'>51</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>*Less = nullptr;</span> 
</span><span class='label'><a id='x1-3109r52'></a><span class='ecrm-0600'>52</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>*More = nullptr;</span> 
</span><span class='label'><a id='x1-3110r53'></a><span class='ecrm-0600'>53</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>idx = 0;</span> 
</span><span class='label'><a id='x1-3111r54'></a><span class='ecrm-0600'>54</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>auto</span></span><span style='color:#000000'> <span class='ectt-1000'>w :</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3112r55'></a><span class='ecrm-0600'>55</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(w &lt;= average_) {</span> 
</span><span class='label'><a id='x1-3113r56'></a><span class='ecrm-0600'>56</span></span><span class='ectt-1000'>          </span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'> <span class='ectt-1000'>=</span> </span><span style='color:#0000FF'><span class='ectt-1000'>new</span></span><span style='color:#000000'> <span class='ectt-1000'>Node{w, idx, Less};</span> 
</span><span class='label'><a id='x1-3114r57'></a><span class='ecrm-0600'>57</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3115r58'></a><span class='ecrm-0600'>58</span></span><span class='ectt-1000'>          </span><span style='color:#000000'><span class='ectt-1000'>More</span></span><span style='color:#000000'> <span class='ectt-1000'>=</span> </span><span style='color:#0000FF'><span class='ectt-1000'>new</span></span><span style='color:#000000'> <span class='ectt-1000'>Node{w, idx, More};</span> 
</span><span class='label'><a id='x1-3116r59'></a><span class='ecrm-0600'>59</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3117r60'></a><span class='ecrm-0600'>60</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>++</span></span><span style='color:#000000'><span class='ectt-1000'>idx</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3118r61'></a><span class='ecrm-0600'>61</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3119r62'></a><span class='ecrm-0600'>62</span></span> 
<span class='label'><a id='x1-3120r63'></a><span class='ecrm-0600'>63</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>reserve</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3121r64'></a><span class='ecrm-0600'>64</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>auto</span></span><span style='color:#000000'> <span class='ectt-1000'>nextAndDelete = [](Node&lt;T&gt; *node) {</span> 
</span><span class='label'><a id='x1-3122r65'></a><span class='ecrm-0600'>65</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>delete</span></span><span style='color:#000000'> <span class='ectt-1000'>node;</span> 
</span><span class='label'><a id='x1-3123r66'></a><span class='ecrm-0600'>66</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3124r67'></a><span class='ecrm-0600'>67</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>while</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'> <span class='ectt-1000'>!= nullptr) {</span> 
</span><span class='label'><a id='x1-3125r68'></a><span class='ecrm-0600'>68</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>*ToDelete = Less;</span> 
</span><span class='label'><a id='x1-3126r69'></a><span class='ecrm-0600'>69</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(Less-&gt;val &lt; average_) {</span> 
</span><span class='label'><a id='x1-3127r70'></a><span class='ecrm-0600'>70</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>lessVal = Less-&gt;val;</span> 
</span><span class='label'><a id='x1-3128r71'></a><span class='ecrm-0600'>71</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>OptionalPair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;{</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>make_pair</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>id</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>lessVal), More != nullptr ? std::make_optional(std::make_pair(More-&gt;id, average_ - lessVal)) : std::nullopt});</span> 
</span><span class='label'><a id='x1-3129r72'></a><span class='ecrm-0600'>72</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'> <span class='ectt-1000'>= Less-&gt;next;</span> 
</span><span class='label'><a id='x1-3130r73'></a><span class='ecrm-0600'>73</span></span><span class='ectt-1000'>            </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(More) {</span> 
</span><span class='label'><a id='x1-3131r74'></a><span class='ecrm-0600'>74</span></span><span class='ectt-1000'>                </span><span style='color:#000000'><span class='ectt-1000'>More</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>val</span></span><span style='color:#000000'> <span class='ectt-1000'>-= average_ - lessVal;</span> 
</span><span class='label'><a id='x1-3132r75'></a><span class='ecrm-0600'>75</span></span><span class='ectt-1000'>                </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(More-&gt;val &lt;= average_ + EPS) {</span> 
</span><span class='label'><a id='x1-3133r76'></a><span class='ecrm-0600'>76</span></span><span class='ectt-1000'>                    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>*tmp = More;</span> 
</span><span class='label'><a id='x1-3134r77'></a><span class='ecrm-0600'>77</span></span><span class='ectt-1000'>                    </span><span style='color:#000000'><span class='ectt-1000'>More</span></span><span style='color:#000000'> <span class='ectt-1000'>= More-&gt;next;</span> 
</span><span class='label'><a id='x1-3135r78'></a><span class='ecrm-0600'>78</span></span><span class='ectt-1000'>                    </span><span style='color:#000000'><span class='ectt-1000'>tmp</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>next</span></span><span style='color:#000000'> <span class='ectt-1000'>= Less;</span> 
</span><span class='label'><a id='x1-3136r79'></a><span class='ecrm-0600'>79</span></span><span class='ectt-1000'>                    </span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'> <span class='ectt-1000'>= tmp;</span> 
</span><span class='label'><a id='x1-3137r80'></a><span class='ecrm-0600'>80</span></span><span class='ectt-1000'>                </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3138r81'></a><span class='ecrm-0600'>81</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3139r82'></a><span class='ecrm-0600'>82</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3140r83'></a><span class='ecrm-0600'>83</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>OptionalPair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;{</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>make_pair</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>id</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>Less-&gt;val), std::nullopt});</span> 
</span><span class='label'><a id='x1-3141r84'></a><span class='ecrm-0600'>84</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>Less</span></span><span style='color:#000000'> <span class='ectt-1000'>= Less-&gt;next;</span> 
</span><span class='label'><a id='x1-3142r85'></a><span class='ecrm-0600'>85</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3143r86'></a><span class='ecrm-0600'>86</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>nextAndDelete</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>ToDelete</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3144r87'></a><span class='ecrm-0600'>87</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3145r88'></a><span class='ecrm-0600'>88</span></span> 
<span class='label'><a id='x1-3146r89'></a><span class='ecrm-0600'>89</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Node</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>*tmp = More;</span> 
</span><span class='label'><a id='x1-3147r90'></a><span class='ecrm-0600'>90</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>while</span></span><span style='color:#000000'> <span class='ectt-1000'>(tmp != nullptr) {</span> 
</span><span class='label'><a id='x1-3148r91'></a><span class='ecrm-0600'>91</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>tmp</span></span><span style='color:#000000'> <span class='ectt-1000'>= tmp-&gt;next;</span> 
</span><span class='label'><a id='x1-3149r92'></a><span class='ecrm-0600'>92</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3150r93'></a><span class='ecrm-0600'>93</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>assert</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>More</span></span><span style='color:#000000'> <span class='ectt-1000'>== nullptr &amp;&amp; Less == nullptr);</span> 
</span><span class='label'><a id='x1-3151r94'></a><span class='ecrm-0600'>94</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3152r95'></a><span class='ecrm-0600'>95</span></span> 
<span class='label'><a id='x1-3153r96'></a><span class='ecrm-0600'>96</span></span> 
<span class='label'><a id='x1-3154r97'></a><span class='ecrm-0600'>97</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3155r98'></a><span class='ecrm-0600'>98</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>Alias&lt;T, C&gt;::sample(std::size_t m) {</span> 
</span><span class='label'><a id='x1-3156r99'></a><span class='ecrm-0600'>99</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>res(m, 0);</span> 
</span><span class='label'><a id='x1-3157r100'></a><span class='ecrm-0600'>100</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(std::size_t i = 0; i &lt; m; ++i) {</span> 
</span><span class='label'><a id='x1-3158r101'></a><span class='ecrm-0600'>101</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>res</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>i</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= sample();</span> 
</span><span class='label'><a id='x1-3159r102'></a><span class='ecrm-0600'>102</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3160r103'></a><span class='ecrm-0600'>103</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>res;</span> 
</span><span class='label'><a id='x1-3161r104'></a><span class='ecrm-0600'>104</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3162r105'></a><span class='ecrm-0600'>105</span></span> 
<span class='label'><a id='x1-3163r106'></a><span class='ecrm-0600'>106</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3164r107'></a><span class='ecrm-0600'>107</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>Alias&lt;T, C&gt;::sample() {</span> 
</span><span class='label'><a id='x1-3165r108'></a><span class='ecrm-0600'>108</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>uniform_int_distribution</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>binDist(0,</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'> <span class='ectt-1000'>- 1);</span> 
</span><span class='label'><a id='x1-3166r109'></a><span class='ecrm-0600'>109</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>OptionalPair</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>p = bins_[rand(</span></span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(0)</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'> <span class='ectt-1000'>- 1)];</span> 
</span><span class='label'><a id='x1-3167r110'></a><span class='ecrm-0600'>110</span></span> 
<span class='label'><a id='x1-3168r111'></a><span class='ecrm-0600'>111</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(!p.p2.has_value()) {</span> 
</span><span class='label'><a id='x1-3169r112'></a><span class='ecrm-0600'>112</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>p.p1.first;</span> 
</span><span class='label'><a id='x1-3170r113'></a><span class='ecrm-0600'>113</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3171r114'></a><span class='ecrm-0600'>114</span></span> 
<span class='label'><a id='x1-3172r115'></a><span class='ecrm-0600'>115</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>r;</span> 
</span><span class='label'><a id='x1-3173r116'></a><span class='ecrm-0600'>116</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>r</span></span><span style='color:#000000'> <span class='ectt-1000'>= rand(</span></span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(0)</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(</span></span><span style='color:#000000'><span class='ectt-1000'>average_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3174r117'></a><span class='ecrm-0600'>117</span></span> 
<span class='label'><a id='x1-3175r118'></a><span class='ecrm-0600'>118</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(r &lt;= p.p1.second)</span> </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>p.p1.first;</span> 
</span><span class='label'><a id='x1-3176r119'></a><span class='ecrm-0600'>119</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>p.p2-&gt;first;</span> 
</span><span class='label'><a id='x1-3177r120'></a><span class='ecrm-0600'>120</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3178r121'></a><span class='ecrm-0600'>121</span></span> 
<span class='label'><a id='x1-3179r122'></a><span class='ecrm-0600'>122</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>endif</span></span><span style='color:#000000'> </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'><span class='ectt-1000'>ALIAS</span></span></pre>
   <!-- l. 379 -->
<figcaption class='caption'><span class='id'>0cAp2x1-3179r2:
    </span><span class='content'>bus.h</span></figcaption><!-- tex4ht:label?: x1-3179r2  --><pre class='lstlisting' id='listing-3'><span class='label'><a id='x1-3180r1'></a><span class='ecrm-0600'>1</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>ifndef</span></span><span style='color:#000000'> <span class='ectt-1000'>BUS</span> 
</span><span class='label'><a id='x1-3181r2'></a><span class='ecrm-0600'>2</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>define</span></span><span style='color:#000000'> <span class='ectt-1000'>BUS</span> 
</span><span class='label'><a id='x1-3182r3'></a><span class='ecrm-0600'>3</span></span> 
<span class='label'><a id='x1-3183r4'></a><span class='ecrm-0600'>4</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;map&gt;</span> 
</span><span class='label'><a id='x1-3184r5'></a><span class='ecrm-0600'>5</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;optional&gt;</span> 
</span><span class='label'><a id='x1-3185r6'></a><span class='ecrm-0600'>6</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;assert.h&gt;</span> 
</span><span class='label'><a id='x1-3186r7'></a><span class='ecrm-0600'>7</span></span> 
<span class='label'><a id='x1-3187r8'></a><span class='ecrm-0600'>8</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> </span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>wss</span></span><span style='color:#FF0000'><span class='ectt-1000'>.</span></span><span style='color:#FF0000'><span class='ectt-1000'>h</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span> 
<span class='label'><a id='x1-3188r9'></a><span class='ecrm-0600'>9</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>include</span></span><span style='color:#000000'> </span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>alias</span></span><span style='color:#FF0000'><span class='ectt-1000'>.</span></span><span style='color:#FF0000'><span class='ectt-1000'>h</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span> 
<span class='label'><a id='x1-3189r10'></a><span class='ecrm-0600'>10</span></span> 
<span class='label'><a id='x1-3190r11'></a><span class='ecrm-0600'>11</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>define</span></span><span style='color:#000000'> <span class='ectt-1000'>max(a, b) (a &gt; b) ? a : b</span> 
</span><span class='label'><a id='x1-3191r12'></a><span class='ecrm-0600'>12</span></span> 
<span class='label'><a id='x1-3192r13'></a><span class='ecrm-0600'>13</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C = std::vector&lt;T&gt;&gt;</span> 
</span><span class='label'><a id='x1-3193r14'></a><span class='ecrm-0600'>14</span></span><span style='color:#0000FF'><span class='ectt-1000'>class</span></span><span style='color:#000000'> <span class='ectt-1000'>Bus :</span> </span><span style='color:#0000FF'><span class='ectt-1000'>public</span></span><span style='color:#000000'> <span class='ectt-1000'>WSS&lt;T, C&gt; {</span> 
</span><span class='label'><a id='x1-3194r15'></a><span class='ecrm-0600'>15</span></span><span style='color:#0000FF'><span class='ectt-1000'>public</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3195r16'></a><span class='ecrm-0600'>16</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Bus</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>C &amp;weight);</span> 
</span><span class='label'><a id='x1-3196r17'></a><span class='ecrm-0600'>17</span></span> 
<span class='label'><a id='x1-3197r18'></a><span class='ecrm-0600'>18</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>sample(std::size_t m) override;</span> 
</span><span class='label'><a id='x1-3198r19'></a><span class='ecrm-0600'>19</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>sample() override;</span> 
</span><span class='label'><a id='x1-3199r20'></a><span class='ecrm-0600'>20</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>bool</span></span><span style='color:#000000'> <span class='ectt-1000'>update(std::size_t idx, T weight) override;</span> 
</span><span class='label'><a id='x1-3200r21'></a><span class='ecrm-0600'>21</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>getBin(std::size_t ele) {</span> 
</span><span class='label'><a id='x1-3201r22'></a><span class='ecrm-0600'>22</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(</span></span><span style='color:#000000'><span class='ectt-1000'>floor</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>log2</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>])</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3202r23'></a><span class='ecrm-0600'>23</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3203r24'></a><span class='ecrm-0600'>24</span></span> 
<span class='label'><a id='x1-3204r25'></a><span class='ecrm-0600'>25</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>getMaxNonEmptyBucket();</span> 
</span><span class='label'><a id='x1-3205r26'></a><span class='ecrm-0600'>26</span></span> 
<span class='label'><a id='x1-3206r27'></a><span class='ecrm-0600'>27</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>struct</span></span><span style='color:#000000'> <span class='ectt-1000'>BucketType {</span> 
</span><span class='label'><a id='x1-3207r28'></a><span class='ecrm-0600'>28</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>ele;</span> 
</span><span class='label'><a id='x1-3208r29'></a><span class='ecrm-0600'>29</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>totalW;</span> 
</span><span class='label'><a id='x1-3209r30'></a><span class='ecrm-0600'>30</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3210r31'></a><span class='ecrm-0600'>31</span></span><span style='color:#0000FF'><span class='ectt-1000'>private</span></span><span style='color:#000000'><span class='ectt-1000'>:</span></span> 
<span class='label'><a id='x1-3211r32'></a><span class='ecrm-0600'>32</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>elementToIdx_;</span> 
</span><span class='label'><a id='x1-3212r33'></a><span class='ecrm-0600'>33</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>map</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>BucketType&gt; bins_;</span> 
</span><span class='label'><a id='x1-3213r34'></a><span class='ecrm-0600'>34</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>totalW_;</span> 
</span><span class='label'><a id='x1-3214r35'></a><span class='ecrm-0600'>35</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>optional</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>maxPower_;</span> 
</span><span class='label'><a id='x1-3215r36'></a><span class='ecrm-0600'>36</span></span><span style='color:#000000'><span class='ectt-1000'>};</span></span> 
<span class='label'><a id='x1-3216r37'></a><span class='ecrm-0600'>37</span></span> 
<span class='label'><a id='x1-3217r38'></a><span class='ecrm-0600'>38</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3218r39'></a><span class='ecrm-0600'>39</span></span><span style='color:#000000'><span class='ectt-1000'>Bus</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>C&gt;::Bus(</span></span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>C&amp; weight) : WSS&lt;T, C&gt;(weight) {</span> 
</span><span class='label'><a id='x1-3219r40'></a><span class='ecrm-0600'>40</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>elementToIdx_</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>assign</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>weight</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>size</span></span><span style='color:#000000'><span class='ectt-1000'>()</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>0);</span> 
</span><span class='label'><a id='x1-3220r41'></a><span class='ecrm-0600'>41</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(std::size_t i = 0; i &lt; weight.size(); ++i) {</span> 
</span><span class='label'><a id='x1-3221r42'></a><span class='ecrm-0600'>42</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>w = weight[i];</span> 
</span><span class='label'><a id='x1-3222r43'></a><span class='ecrm-0600'>43</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>power = floor(std::log2(w));</span> 
</span><span class='label'><a id='x1-3223r44'></a><span class='ecrm-0600'>44</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(!bins_.contains(power)) {</span> 
</span><span class='label'><a id='x1-3224r45'></a><span class='ecrm-0600'>45</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>power</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= BucketType(std::vector&lt;std::size_t&gt;{}, 0);</span> 
</span><span class='label'><a id='x1-3225r46'></a><span class='ecrm-0600'>46</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3226r47'></a><span class='ecrm-0600'>47</span></span> 
<span class='label'><a id='x1-3227r48'></a><span class='ecrm-0600'>48</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>totalW_</span></span><span style='color:#000000'> <span class='ectt-1000'>+= w;</span> 
</span><span class='label'><a id='x1-3228r49'></a><span class='ecrm-0600'>49</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>power</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>totalW</span></span><span style='color:#000000'> <span class='ectt-1000'>+= w;</span> 
</span><span class='label'><a id='x1-3229r50'></a><span class='ecrm-0600'>50</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>elementToIdx_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>i</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= bins_[power].ele.size();</span> 
</span><span class='label'><a id='x1-3230r51'></a><span class='ecrm-0600'>51</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>power</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>i</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3231r52'></a><span class='ecrm-0600'>52</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>maxPower_</span></span><span style='color:#000000'> <span class='ectt-1000'>= max(power, maxPower_);</span> 
</span><span class='label'><a id='x1-3232r53'></a><span class='ecrm-0600'>53</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3233r54'></a><span class='ecrm-0600'>54</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3234r55'></a><span class='ecrm-0600'>55</span></span> 
<span class='label'><a id='x1-3235r56'></a><span class='ecrm-0600'>56</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3236r57'></a><span class='ecrm-0600'>57</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>Bus&lt;T, C&gt;::getMaxNonEmptyBucket() {</span> 
</span><span class='label'><a id='x1-3237r58'></a><span class='ecrm-0600'>58</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(maxPower_)</span> </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>maxPower_.value();</span> 
</span><span class='label'><a id='x1-3238r59'></a><span class='ecrm-0600'>59</span></span> 
<span class='label'><a id='x1-3239r60'></a><span class='ecrm-0600'>60</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>R = floor(std::log2(totalW_));</span> 
</span><span class='label'><a id='x1-3240r61'></a><span class='ecrm-0600'>61</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>L = R - floor(std::log2(</span></span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3241r62'></a><span class='ecrm-0600'>62</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>idx = R; idx &gt;= L; --idx) {</span> 
</span><span class='label'><a id='x1-3242r63'></a><span class='ecrm-0600'>63</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(bins_.count(idx)) { maxPower_ = idx;</span> </span><span style='color:#0000FF'><span class='ectt-1000'>break</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span><span style='color:#000000'> <span class='ectt-1000'>}</span> 
</span><span class='label'><a id='x1-3243r64'></a><span class='ecrm-0600'>64</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3244r65'></a><span class='ecrm-0600'>65</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>assert</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#FF0000'><span class='ectt-1000'>Bug</span></span><span style='color:#FF0000'><span class='ectt-1000'>:</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>maxPower_</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>is</span></span><span style='color:#FF0000'><span class='ectt-1000'>␣</span></span><span style='color:#FF0000'><span class='ectt-1000'>empty</span></span><span style='color:#FF0000'><span class='ectt-1000'>"</span></span><span style='color:#000000'> <span class='ectt-1000'>&amp;&amp; maxPower_);</span> 
</span><span class='label'><a id='x1-3245r66'></a><span class='ecrm-0600'>66</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>maxPower_.value();</span> 
</span><span class='label'><a id='x1-3246r67'></a><span class='ecrm-0600'>67</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3247r68'></a><span class='ecrm-0600'>68</span></span> 
<span class='label'><a id='x1-3248r69'></a><span class='ecrm-0600'>69</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3249r70'></a><span class='ecrm-0600'>70</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>Bus&lt;T, C&gt;::sample() {</span> 
</span><span class='label'><a id='x1-3250r71'></a><span class='ecrm-0600'>71</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>sample(1)[0];</span> 
</span><span class='label'><a id='x1-3251r72'></a><span class='ecrm-0600'>72</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3252r73'></a><span class='ecrm-0600'>73</span></span> 
<span class='label'><a id='x1-3253r74'></a><span class='ecrm-0600'>74</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3254r75'></a><span class='ecrm-0600'>75</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>Bus&lt;T, C&gt;::sample(std::size_t m) {</span> 
</span><span class='label'><a id='x1-3255r76'></a><span class='ecrm-0600'>76</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>res; res.reserve(m);</span> 
</span><span class='label'><a id='x1-3256r77'></a><span class='ecrm-0600'>77</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>r = getMaxNonEmptyBucket();</span> 
</span><span class='label'><a id='x1-3257r78'></a><span class='ecrm-0600'>78</span></span> 
<span class='label'><a id='x1-3258r79'></a><span class='ecrm-0600'>79</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>cutOff = 0;</span> 
</span><span class='label'><a id='x1-3259r80'></a><span class='ecrm-0600'>80</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>aliasWeight;</span> 
</span><span class='label'><a id='x1-3260r81'></a><span class='ecrm-0600'>81</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>vector</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>idxToPower;</span> 
</span><span class='label'><a id='x1-3261r82'></a><span class='ecrm-0600'>82</span></span> 
<span class='label'><a id='x1-3262r83'></a><span class='ecrm-0600'>83</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>i = r - 2*floor(std::log2(</span></span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span><span style='color:#000000'> <span class='ectt-1000'>i &lt;= r; ++i) {</span> 
</span><span class='label'><a id='x1-3263r84'></a><span class='ecrm-0600'>84</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(!bins_.count(i))</span> </span><span style='color:#0000FF'><span class='ectt-1000'>continue</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3264r85'></a><span class='ecrm-0600'>85</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>cutOff</span></span><span style='color:#000000'> <span class='ectt-1000'>+= bins_[i].totalW;</span> 
</span><span class='label'><a id='x1-3265r86'></a><span class='ecrm-0600'>86</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>aliasWeight</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>i</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>totalW</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3266r87'></a><span class='ecrm-0600'>87</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>idxToPower</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>i</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3267r88'></a><span class='ecrm-0600'>88</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3268r89'></a><span class='ecrm-0600'>89</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>cutOff</span></span><span style='color:#000000'> <span class='ectt-1000'>= totalW_ - cutOff;</span> 
</span><span class='label'><a id='x1-3269r90'></a><span class='ecrm-0600'>90</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>Alias</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;</span></span><span style='color:#000000'> <span class='ectt-1000'>alias(aliasWeight);</span> 
</span><span class='label'><a id='x1-3270r91'></a><span class='ecrm-0600'>91</span></span> 
<span class='label'><a id='x1-3271r92'></a><span class='ecrm-0600'>92</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>while</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>m</span></span><span style='color:#000000'><span class='ectt-1000'>--)</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3272r93'></a><span class='ecrm-0600'>93</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>wI = rand(0.0, totalW_), preSumWI = cutOff;</span> 
</span><span class='label'><a id='x1-3273r94'></a><span class='ecrm-0600'>94</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>bool</span></span><span style='color:#000000'> <span class='ectt-1000'>found =</span> </span><span style='color:#0000FF'><span class='ectt-1000'>false</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3274r95'></a><span class='ecrm-0600'>95</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>idx;</span> 
</span><span class='label'><a id='x1-3275r96'></a><span class='ecrm-0600'>96</span></span> 
<span class='label'><a id='x1-3276r97'></a><span class='ecrm-0600'>97</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> <span class='ectt-1000'>With high probability that we will find idx &gt;= r - (r ? floor(2 * std::log2(r)) : 0).</span> 
</span><span class='label'><a id='x1-3277r98'></a><span class='ecrm-0600'>98</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> <span class='ectt-1000'>Build the Alias method data structure for for powers with [r - 2logn, ..., r].</span> 
</span><span class='label'><a id='x1-3278r99'></a><span class='ecrm-0600'>99</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> <span class='ectt-1000'>For alias method:</span> 
</span><span class='label'><a id='x1-3279r100'></a><span class='ecrm-0600'>100</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>      </span><span style='color:#009900'><span class='ectt-1000'>1.</span></span><span style='color:#009900'> <span class='ectt-1000'>Find the cutoff weight between buckets of power r-2log(r) - 1 and r - 2log(r).</span> 
</span><span class='label'><a id='x1-3280r101'></a><span class='ecrm-0600'>101</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>      </span><span style='color:#009900'><span class='ectt-1000'>2.</span></span><span style='color:#009900'> <span class='ectt-1000'>Sample a weight from [0, totalW_].</span> 
</span><span class='label'><a id='x1-3281r102'></a><span class='ecrm-0600'>102</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>      </span><span style='color:#009900'><span class='ectt-1000'>3.</span></span><span style='color:#009900'> <span class='ectt-1000'>If the sampled weight is in good case i.e. greater than cut off point then</span> 
</span><span class='label'><a id='x1-3282r103'></a><span class='ecrm-0600'>103</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>         </span><span style='color:#009900'><span class='ectt-1000'>we</span></span><span style='color:#009900'> <span class='ectt-1000'>use alias method on buckets of power [r-2log n, ..., r] which computes in O(1) time.</span> 
</span><span class='label'><a id='x1-3283r104'></a><span class='ecrm-0600'>104</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>      </span><span style='color:#009900'><span class='ectt-1000'>4.</span></span><span style='color:#009900'> <span class='ectt-1000'>Otherwise use brute force on buckets of power [lowest, ..., r - 2logn] which happens</span> 
</span><span class='label'><a id='x1-3284r105'></a><span class='ecrm-0600'>105</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> </span><span class='ectt-1000'>         </span><span style='color:#009900'><span class='ectt-1000'>with</span></span><span style='color:#009900'> <span class='ectt-1000'>probability O(1/n) with time cost O(n).</span> 
</span><span class='label'><a id='x1-3285r106'></a><span class='ecrm-0600'>106</span></span><span class='ectt-1000'>        </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'> <span class='ectt-1000'>Using the above described sampling technique yields an amortized time of O(log(n) + m) for m samples.</span> 
</span><span class='label'><a id='x1-3286r107'></a><span class='ecrm-0600'>107</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(wI &gt;= cutOff) {</span> 
</span><span class='label'><a id='x1-3287r108'></a><span class='ecrm-0600'>108</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>idx</span></span><span style='color:#000000'> <span class='ectt-1000'>= idxToPower[alias.sample()];</span> 
</span><span class='label'><a id='x1-3288r109'></a><span class='ecrm-0600'>109</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3289r110'></a><span class='ecrm-0600'>110</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>idx</span></span><span style='color:#000000'> <span class='ectt-1000'>= r - 2*floor(std::log2(</span></span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>n_</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'> <span class='ectt-1000'>- 1;</span> 
</span><span class='label'><a id='x1-3290r111'></a><span class='ecrm-0600'>111</span></span><span class='ectt-1000'>            </span><span style='color:#0000FF'><span class='ectt-1000'>for</span></span><span style='color:#000000'> <span class='ectt-1000'>(; ; --idx) {</span> 
</span><span class='label'><a id='x1-3291r112'></a><span class='ecrm-0600'>112</span></span><span class='ectt-1000'>                </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(!bins_.count(idx))</span> </span><span style='color:#0000FF'><span class='ectt-1000'>continue</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3292r113'></a><span class='ecrm-0600'>113</span></span><span class='ectt-1000'>                </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(wI &gt;= preSumWI - bins_[idx].totalW) {</span> 
</span><span class='label'><a id='x1-3293r114'></a><span class='ecrm-0600'>114</span></span><span class='ectt-1000'>                    </span><span style='color:#000000'><span class='ectt-1000'>found</span></span><span style='color:#000000'> <span class='ectt-1000'>= 1;</span> </span><span style='color:#0000FF'><span class='ectt-1000'>break</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3294r115'></a><span class='ecrm-0600'>115</span></span><span class='ectt-1000'>                </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3295r116'></a><span class='ecrm-0600'>116</span></span><span class='ectt-1000'>                </span><span style='color:#000000'><span class='ectt-1000'>preSumWI</span></span><span style='color:#000000'> <span class='ectt-1000'>= preSumWI - bins_[idx].totalW;</span> 
</span><span class='label'><a id='x1-3296r117'></a><span class='ecrm-0600'>117</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3297r118'></a><span class='ecrm-0600'>118</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3298r119'></a><span class='ecrm-0600'>119</span></span> 
<span class='label'><a id='x1-3299r120'></a><span class='ecrm-0600'>120</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>const</span></span><span style='color:#000000'> <span class='ectt-1000'>std::vector&lt;std::size_t&gt; &amp;ele = bins_[idx].ele;</span> 
</span><span class='label'><a id='x1-3300r121'></a><span class='ecrm-0600'>121</span></span><span class='ectt-1000'>        </span><span style='color:#0000FF'><span class='ectt-1000'>while</span></span><span style='color:#000000'> <span class='ectt-1000'>(</span></span><span style='color:#0000FF'><span class='ectt-1000'>true</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3301r122'></a><span class='ecrm-0600'>122</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'> <span class='ectt-1000'>x = rand(</span></span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(0)</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>T</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(1</span></span><span style='color:#000000'><span class='ectt-1000'>ULL</span></span><span style='color:#000000'> <span class='ectt-1000'>&lt;&lt; (idx+1)));</span> 
</span><span class='label'><a id='x1-3302r123'></a><span class='ecrm-0600'>123</span></span><span class='ectt-1000'>            </span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'> <span class='ectt-1000'>eleIdx = ele[rand(</span></span><span style='color:#0000FF'><span class='ectt-1000'>static_cast</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>std</span></span><span style='color:#000000'><span class='ectt-1000'>::</span></span><span style='color:#000000'><span class='ectt-1000'>size_t</span></span><span style='color:#000000'><span class='ectt-1000'>&gt;(0)</span></span><span style='color:#000000'><span class='ectt-1000'>,</span></span><span style='color:#000000'> <span class='ectt-1000'>ele.size() - 1)];</span> 
</span><span class='label'><a id='x1-3303r124'></a><span class='ecrm-0600'>124</span></span><span class='ectt-1000'>            </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(x &lt;=</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>eleIdx</span></span><span style='color:#000000'><span class='ectt-1000'>])</span></span><span style='color:#000000'> <span class='ectt-1000'>{ res.push_back(eleIdx);</span> </span><span style='color:#0000FF'><span class='ectt-1000'>break</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span><span style='color:#000000'> <span class='ectt-1000'>}</span> 
</span><span class='label'><a id='x1-3304r125'></a><span class='ecrm-0600'>125</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3305r126'></a><span class='ecrm-0600'>126</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3306r127'></a><span class='ecrm-0600'>127</span></span> 
<span class='label'><a id='x1-3307r128'></a><span class='ecrm-0600'>128</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> <span class='ectt-1000'>res;</span> 
</span><span class='label'><a id='x1-3308r129'></a><span class='ecrm-0600'>129</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3309r130'></a><span class='ecrm-0600'>130</span></span> 
<span class='label'><a id='x1-3310r131'></a><span class='ecrm-0600'>131</span></span><span style='color:#0000FF'><span class='ectt-1000'>template</span></span><span style='color:#000000'><span class='ectt-1000'>&lt;</span></span><span style='color:#000000'><span class='ectt-1000'>Numeric</span></span><span style='color:#000000'> <span class='ectt-1000'>T, ContainerOf&lt;T&gt; C&gt;</span> 
</span><span class='label'><a id='x1-3311r132'></a><span class='ecrm-0600'>132</span></span><span style='color:#0000FF'><span class='ectt-1000'>bool</span></span><span style='color:#000000'> <span class='ectt-1000'>Bus&lt;T, C&gt;::update(std::size_t ele, T weight) {</span> 
</span><span class='label'><a id='x1-3312r133'></a><span class='ecrm-0600'>133</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>binIdx = getBin(ele);</span> 
</span><span class='label'><a id='x1-3313r134'></a><span class='ecrm-0600'>134</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>int</span></span><span style='color:#000000'> <span class='ectt-1000'>insertIdx = floor(std::log2(weight));</span> 
</span><span class='label'><a id='x1-3314r135'></a><span class='ecrm-0600'>135</span></span> 
<span class='label'><a id='x1-3315r136'></a><span class='ecrm-0600'>136</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>binIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>elementToIdx_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>]]</span></span><span style='color:#000000'> <span class='ectt-1000'>= bins_[binIdx].ele.back();</span> 
</span><span class='label'><a id='x1-3316r137'></a><span class='ecrm-0600'>137</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>elementToIdx_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>binIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>back</span></span><span style='color:#000000'><span class='ectt-1000'>()</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= elementToIdx_[ele];</span> 
</span><span class='label'><a id='x1-3317r138'></a><span class='ecrm-0600'>138</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>binIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>pop_back</span></span><span style='color:#000000'><span class='ectt-1000'>()</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3318r139'></a><span class='ecrm-0600'>139</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>binIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>totalW</span></span><span style='color:#000000'> <span class='ectt-1000'>-=</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>];</span></span> 
<span class='label'><a id='x1-3319r140'></a><span class='ecrm-0600'>140</span></span> 
<span class='label'><a id='x1-3320r141'></a><span class='ecrm-0600'>141</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(bins_[binIdx].ele.size() == 0) bins_.erase(binIdx);</span> 
</span><span class='label'><a id='x1-3321r142'></a><span class='ecrm-0600'>142</span></span> 
<span class='label'><a id='x1-3322r143'></a><span class='ecrm-0600'>143</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>elementToIdx_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= bins_[insertIdx].ele.size();</span> 
</span><span class='label'><a id='x1-3323r144'></a><span class='ecrm-0600'>144</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>insertIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>push_back</span></span><span style='color:#000000'><span class='ectt-1000'>(</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>)</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3324r145'></a><span class='ecrm-0600'>145</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>bins_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>insertIdx</span></span><span style='color:#000000'><span class='ectt-1000'>].</span></span><span style='color:#000000'><span class='ectt-1000'>totalW</span></span><span style='color:#000000'> <span class='ectt-1000'>+= weight;</span> 
</span><span class='label'><a id='x1-3325r146'></a><span class='ecrm-0600'>146</span></span> 
<span class='label'><a id='x1-3326r147'></a><span class='ecrm-0600'>147</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>totalW_</span></span><span style='color:#000000'> <span class='ectt-1000'>+= weight -</span> </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>];</span></span> 
<span class='label'><a id='x1-3327r148'></a><span class='ecrm-0600'>148</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>this</span></span><span style='color:#000000'><span class='ectt-1000'>-&gt;</span></span><span style='color:#000000'><span class='ectt-1000'>weight_</span></span><span style='color:#000000'><span class='ectt-1000'>[</span></span><span style='color:#000000'><span class='ectt-1000'>ele</span></span><span style='color:#000000'><span class='ectt-1000'>]</span></span><span style='color:#000000'> <span class='ectt-1000'>= weight;</span> 
</span><span class='label'><a id='x1-3328r149'></a><span class='ecrm-0600'>149</span></span> 
<span class='label'><a id='x1-3329r150'></a><span class='ecrm-0600'>150</span></span> 
<span class='label'><a id='x1-3330r151'></a><span class='ecrm-0600'>151</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>if</span></span><span style='color:#000000'> <span class='ectt-1000'>(binIdx &lt;= insertIdx) {</span> 
</span><span class='label'><a id='x1-3331r152'></a><span class='ecrm-0600'>152</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>maxPower_</span></span><span style='color:#000000'> <span class='ectt-1000'>= max(insertIdx, maxPower_);</span> 
</span><span class='label'><a id='x1-3332r153'></a><span class='ecrm-0600'>153</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>else</span></span><span style='color:#000000'> <span class='ectt-1000'>{</span> 
</span><span class='label'><a id='x1-3333r154'></a><span class='ecrm-0600'>154</span></span><span class='ectt-1000'>        </span><span style='color:#000000'><span class='ectt-1000'>maxPower_</span></span><span style='color:#000000'><span class='ectt-1000'>.</span></span><span style='color:#000000'><span class='ectt-1000'>reset</span></span><span style='color:#000000'><span class='ectt-1000'>()</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3334r155'></a><span class='ecrm-0600'>155</span></span><span class='ectt-1000'>    </span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3335r156'></a><span class='ecrm-0600'>156</span></span> 
<span class='label'><a id='x1-3336r157'></a><span class='ecrm-0600'>157</span></span><span class='ectt-1000'>    </span><span style='color:#0000FF'><span class='ectt-1000'>return</span></span><span style='color:#000000'> </span><span style='color:#0000FF'><span class='ectt-1000'>true</span></span><span style='color:#000000'><span class='ectt-1000'>;</span></span> 
<span class='label'><a id='x1-3337r158'></a><span class='ecrm-0600'>158</span></span><span style='color:#000000'><span class='ectt-1000'>}</span></span> 
<span class='label'><a id='x1-3338r159'></a><span class='ecrm-0600'>159</span></span> 
<span class='label'><a id='x1-3339r160'></a><span class='ecrm-0600'>160</span></span><span style='color:#0000FF'><span class='ectt-1000'>#</span></span><span style='color:#0000FF'><span class='ectt-1000'>endif</span></span><span style='color:#000000'> </span><span style='color:#009900'><span class='ectt-1000'>//</span></span><span style='color:#009900'><span class='ectt-1000'>BUS</span></span></pre>
<!-- l. 1 --><p class='noindent'>
</p>
   <h3 class='likesectionHead' id='references'><a id='x1-4000'></a>References</h3>
<!-- l. 1 --><p class='noindent'>
         </p><div class='thebibliography'>
         <p class='bibitem'><span class='biblabel'>
 [ZJW23]<span class='bibsp'>   </span></span><a id='XWSS'></a>Fangyuan Zhang, Mengxu Jiang, and Sibo Wang.   Efficient dynamic weighted set
         sampling and its extension. 17(1), 2023.
</p>
         </div>
    
</body> 
</html>